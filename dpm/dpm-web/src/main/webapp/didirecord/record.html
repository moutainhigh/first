<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>备案</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="./js/layui/css/layui.css"  media="all">
    <link rel="stylesheet" href="./css/font-awesome.min.css"  media="all">
    <link rel="stylesheet" href="/dpm/appdetail/lib/font-awesome-4.7.0/css/font-awesome.min.css">
    <style type="text/css">
        .grid-demo{
            background-color: #eee;
        }
        .recordDataOperationLayer{
            border: 3px solid #E6E6E6;
        }
        .imgLg{
            border: 3px solid #E6E6E6;
        }
        .imgLg img{
            width: 330px;
            height: 600px;
        }
        .operationLayer{
            display: none;
        }
        .operationLayer .layui-form-item{
            padding-right: 80px;
        }
        .operationLayer .imgBox{
            width: 100%;
            overflow: hidden;
            display: flex;
            justify-content: flex-start;
        }
        .operationLayer .imgBox dd{
            width: 100px;            
            margin:10px 60px 10px 0;
            height: 160px;  
            border: 1px solid #ddd;
            border-radius: 3px;
            background-size: cover;
            cursor: pointer;
        }
        .operationLayer .imgBox img{
            width: 100px;
            height: 160px;  
            cursor: pointer;
        }
        .operationLayer .recordstateBox{
            margin-left: 110px;
            min-height: 36px;
        }
        .operationLayer .recordstateBox select{
            width: 100%;
            height: 38px;
            line-height: 1.3;
            line-height: 38px\9;
            border-width: 1px;
            border-style: solid;
            background-color: #fff;
            border-radius: 2px;
        }

        .layui-form .layui-table-box .layui-table-header .layui-table thead tr th{
        	background-color: #009688;
        	color: #fff;
        	text-align: center;
        }
    </style>
</head>
<body>

	<!-- 菜单栏 -->
	<div class="header">
		<div class="w990">
			<div class="head-nav">
				<ul>
					<li><a href="/dpm/feedback/pages/report1.html?" id="menu-send">意见反馈</a></li>
					<li><a href="/dpm/appdetail/pages/appDetailList.jsp?">应用详情</a></li>
                    <li><a href="" id="menu-track">德邦欢行 <i class="fa fa-angle-down fa-lg"></i></a>
                        <ul>
                            <li><a href="/dpm/didirecord/record.html?">欢行备案</a></li>
                            <li><a href="/dpm/didirecord/upPhone.html?">欢行手机号</a></li>
                            <li><a href="/dpm/didirecord/account.html?">欢行报账</a></li>
                            <li><a href="/dpm/didirecord/approver.html?">修改审批人</a></li>
                            <li><a href="/dpm/didirecord/message_push.html?">提示推送</a></li>
                            <li><a href="/dpm/feedback/pages/report3.html?">开启/关闭验证</a></li>
                            <li><a href="/dpm/didirecord/orderCallBack.html?">欢行订单回调</a></li>
                        </ul>
                    </li>
				</ul>
			</div>
			<a href="/dpm/feedback/pages/login.html" class="btn-default btn-loginout">注销</a>
		</div>
	</div>

	<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->  
<!--     <fieldset class="layui-elem-field layui-field-title" >
      <legend>备案</legend>
    </fieldset> -->
    <div class="layui-row">
        <div class="layui-col-xs3 ">
            <form class="layui-form  layui-table" action="">

                <div class="layui-form-item">
                    <label class="layui-form-label">姓名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="username"  placeholder="请输入姓名" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">工号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="userId"  placeholder="请输入工号" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">部门</label>
                    <div class="layui-input-inline">
                        <input type="text" name="dept"  placeholder="请输入部门" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">备案时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="startTime" id="startTime"  placeholder="请输入开始时间" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-inline">
                        <input type="text" name="endtime" id="endtime"  placeholder="请输入结束时间" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">备案类型</label>
                    <div class="layui-input-inline">
                        <!-- <input type="radio" name="recordtype" value="0" title="预算不足" ><br /> -->
                        <input type="radio" name="recordtype" value="0" title="未配置预算" ><br />
                        <input type="radio" name="recordtype" value="1" title="系统异常" ><br />
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">备案状态</label>
                    <div class="layui-input-inline">
                        <input type="radio" name="recordstate" value="0" title="待审核"><br />
                        <input type="radio" name="recordstate" value="1" title="通过" ><br />
                        <input type="radio" name="recordstate" value="2" title=不通过 ><br />
                    </div>
                </div>
                <div class="layui-form-item layui-col-xs4 layui-col-md-offset3" style="text-align: center;">
                    <button class="layui-btn layui-btn-fluid" lay-submit lay-filter="query">查询</button>
                </div>
            </form>
        </div>
        <div class="layui-col-xs9">
            <table id="demo" lay-filter="test"></table>
        </div>
    </div>
    <ul class="operationLayer">
        <form class="layui-form layui-table" action="" lay-filter="update">
            <div class="layui-form-item">
                <label class="layui-form-label">图片</label>
                <div class="layui-input-block">
                    <dl class="imgBox" id="#layer-photos-demo">
                    </dl>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">备案状态</label>
                <div class="layui-input-block recordstateBox">
                    <select class="recordstate " name="recordstate" lay-verify="required" lay-filter="recordstate" lay-ignore>
                        <!-- <option value=""></option> -->
                        <option value="0">待审核</option>
                        <option value="1">通过</option>
                        <option value="2">不通过</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">批复意见</label>
                <div class="layui-input-block"  >
                    <textarea   name="comment" required  placeholder="请输入" class="layui-textarea comment" lay-ignore></textarea>
                </div>
            </div>
            <li class="item">
                <div class="layui-form-item layui-col-xs5 layui-col-md-offset4" style="text-align: center;">
                    <button class="layui-btn layui-btn-fluid" lay-submit lay-filter="update">修改</button>
                </div>
            </li>
        </form>
    </ul>
    <script type="text/html" id="barDemo">
      <!-- <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a> -->
      <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
      <!-- <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a> -->
    </script>
</body>

    <script type="text/javascript" src="./js/jq.js"></script>
    <script src="./js/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/laydate/laydate.js"></script>
    <script>

        //http://192.168.2.72:8080/dpm/dpm-doc/PcKeepRecord_queryKeepRecordPC.action
        $(function () {
            // var ip = 'http://192.168.68.117:8080';
            var ip = 'https://dpm.deppon.com:8881';
            // var ip = 'http://192.168.2.72:8080';
            // var ip = 'http://192.168.2.59:8080';
            var imgUrl = ip + '/dpm/dpmfile/didirecord/';
            var ADDR = ip + '/dpm/dpm-doc/';
            var updateId = '';
            var updateRecordstate = '';
            var updateComment = '';

            layui.use(['laydate', 'layer', 'table' ,'form'], function(){
                var table = layui.table;
                var laydate = layui.laydate;
                var form = layui.form;
                var layer = layui.layer;
              
              //第一个实例
                table.render({
                    elem: '#demo'
                    ,height: 'full-130'
                    // ,url: ADDR + 'keeponrecord_queryRecordByCondition.action' //数据接口
                    ,url: ADDR + 'PcKeepRecord_queryKeepRecordPC.action' //新数据接口
                    ,where:{
                        // userId:'149607'
                        // ,pageNum:1
                    }
                    ,request: {
                        pageName: 'pageNum' //页码的参数名称，默认：page
                        // ,limitName: 'limit' //每页数据量的参数名，默认：limit
                    }
                    ,response: {
                        statusCode: 200 //成功的状态码，默认：0
                        ,countName: 'totalnum' //数据总数的字段名称，默认：count
                        ,dataName: 'List' //数据列表的字段名称，默认：data
                    } 
                    ,limit:15
                    ,limits:[15,20,25,30]
                    ,page: true //开启分页
                    ,cols: [[ //表头
                        {field: 'dept', title: '部门',width:120}
                        ,{field: 'userId', title: '工号'}
                        ,{field: 'userName', title: '用户名'}
                        ,{field: 'taxidate', title: '时间', }
                        ,{field: 'recordtype', title: '类型', }
                        ,{field: 'fromName', title: '出发地', }
                        ,{field: 'toName', title: '目的地', }
                        ,{field: 'amount', title: '金额', width:60}
                        ,{field: 'carremark', title: '备注内容', }
                        ,{field: 'recordstate', title: '备案状态', sort: true}
                        ,{fixed: 'right',title: '操作', width: 80, align:'center', toolbar: '#barDemo'}
                    ]]
                    ,done: function(res, curr, count){
                        console.log('第一次查询',res);
                        res = [];
                    }
                });
              

                //表单提交
                form.on('submit(query)', function(data){
                    // console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
                    var startTime = data.field.startTime;
                    var endtime = data.field.endtime;
                    console.log(startTime);
                    if (startTime  != '') {
                        startTime = startTime + ' 00:00:00';
                    }
                    if (endtime) {
                        endtime = endtime + ' 00:00:00';
                    }
                    table.render({
                        elem: '#demo'
                        ,height: 'full-130'
                        // ,url: ADDR + 'keeponrecord_queryRecordByCondition.action' //数据接口
                        ,url: ADDR + 'PcKeepRecord_queryKeepRecordPC.action' //新数据接口
                        ,where:{
                            userId : data.field.userId
                            ,dept : data.field.dept
                            ,endtime : endtime
                            ,starttime : startTime
                            ,userName : data.field.username
                            ,recordstate : data.field.recordstate
                            ,recordtype : data.field.recordtype
                            // ,pageNum:1
                        }
                        ,limit:15
                        ,limits:[15,20,25,30]
                        ,request: {
                            pageName: 'pageNum' //页码的参数名称，默认：page
                            // ,limitName: 'limit' //每页数据量的参数名，默认：limit
                        }
                        ,response: {
                            statusCode: 200 //成功的状态码，默认：0
                            ,countName: 'totalnum' //数据总数的字段名称，默认：count
                            ,dataName: 'List' //数据列表的字段名称，默认：data
                        } 
                        ,page: true //开启分页
                        ,cols: [[ //表头
                            
	                        {field: 'dept', title: '部门',width:120}
	                        ,{field: 'userId', title: '工号'}
	                        ,{field: 'userName', title: '用户名'}
	                        ,{field: 'taxidate', title: '时间', }
	                        ,{field: 'recordtype', title: '类型', }
	                        ,{field: 'fromName', title: '出发地', }
	                        ,{field: 'toName', title: '目的地', }
	                        ,{field: 'amount', title: '金额', width:60}
                            ,{field: 'carremark', title: '备注内容', }
                            ,{field: 'recordstate', title: '备案状态', }
                            ,{fixed: 'right',title: '操作', width: 80, align:'center', toolbar: '#barDemo'}
                        ]]
                        ,done: function(res, curr, count){
                            console.log('第二次查询',res);
                            // imgUrl = res.imgurl;
                            res = [];
                        }
                    });
                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                });

                form.on('submit(update)', function(data){
                    // console.log(data.field);
                    updateRecordstate = $('.recordstate').val();
                    updateComment = $("textarea[name='comment']").val();
                    $.ajax({
                        url: ADDR + 'didirecord_updateRecode.action',
                        type:'POST', //GET
                        async:true,    //或false,是否异步
                        data:{
                            id : updateId,
                            recordstate : updateRecordstate,
                            comment : updateComment
                        },
                        timeout:60000,       //超时时间
                        dataType:'json',    //返回的数据格式：json/xml/html/script/jsonp/text
                        success:function(data,textStatus,jqXHR){
                            layer.closeAll();
                            layer.msg('修改成功');
                            table.reload('demo');
                        },
                        error:function(data,xhr,textStatus){
                            layer.closeAll();
                            layer.msg('修改失败');
                            
                        }
                    });
                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                });
                //数据操作<table id="demo" lay-filter="test"></table>
                table.on('tool(test)', function(obj){ 
                    //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                    var data = obj.data //获得当前行数据
                    ,layEvent = obj.event; //获得 lay-event 对应的值
                    updateId = data.id;   // 获取当前数据的id
                    console.log('当前行',data);
                    $('.comment').val(data.comment);
                    if(layEvent === 'detail'){
                        layer.msg('查看操作');
                    } else if(layEvent === 'del'){
                        layer.confirm('真的删除行么', function(index){
                            obj.del(); //删除对应行（tr）的DOM结构
                            layer.close(index);
                            //向服务端发送删除指令
                        });
                    } else if(layEvent === 'edit'){
                        $(".recordstate option").each(function(){
                            if ($(this).text() == data.recordstate) {
                                $(this).attr("selected",true);
                            }
                        });
                        //置空
                        $(".imgBox").html(' ');
                        data.recordpicArray.forEach(function(val,index){
                            // $(".imgBox").append("<dd><img class='a_block' layer-src='http://192.168.68.117:8080/dpm/dpmfile/didirecord/"+ val +"' src='http://192.168.68.117:8080/dpm/dpmfile/didirecord/"+ val +"'></dd>")
                            console.log(data.imgurl)
                            $(".imgBox").append("<dd><img class='a_block' layer-src='"+ imgUrl + val +"' src='"+ imgUrl + val +"'></dd>")
                            // $(".imgBox").append("<img layer-pid layer-src='http://192.168.68.117:8080/dpm/dpmfile/didirecord/"+ val +"' layer-index='"+ index +"' src='http://192.168.68.117:8080/dpm/dpmfile/didirecord/"+ val +"'>");
                        })

                        //处理图片加载失败
                        $('img').error(function(){
                            $(this).attr('src', "./images/error.png");
                        });
                        layer.open({
                            type: 1,
                            skin: 'recordDataOperationLayer', //加上边框
                            area: ['840px', '480px'], //宽高
                            content: $('.operationLayer')
                        });
                        // $('.recordstate').change(function(){
                        //     // obj.update({
                        //     //   username: '123'
                        //     //   ,title: 'xxx'
                        //     // });
                        //     var thisRecordState = $(this).val();
                        //     if (thisRecordState == 1) {
                        //         obj.update({
                        //           recordstate: '通过'
                        //         });
                        //     }else if (thisRecordState == 2) {
                        //         obj.update({
                        //           recordstate: '不通过'
                        //         });
                        //     }else {
                        //         obj.update({
                        //           recordstate: '待审核'
                        //         });
                        //     }
                        // })
                    }
                });

            });

            // 选择开始结束时间
            var start = {
                elem: '#startTime'
                ,type: 'datetime'
                ,format: 'YYYY/MM/DD'
                ,min: '1900-01-01 00:00:00' //最小日期
                ,max: laydate.now()
                ,calendar: true 
                // ,max: '00:00:00'
                ,choose: function(datas){
                    end.min = datas; //开始日选好后，重置结束日的最小日期
                    end.start = datas //将结束日的初始值设定为开始日
                }
            };
            var end = {
                elem: '#endtime'
                ,format: 'YYYY/MM/DD'
                ,min: '1900-01-01 00:00:00' //最小日期
                ,max: laydate.now()
                ,istime: false
                ,istoday: false
                ,choose: function(datas){
                    start.max = datas; //结束日选好后，重置开始日的最大日期
                }
            };
            laydate(start);
            laydate(end);

            //点击图片

            $(document).on("click", ".a_block", function () {
                var pcWidth = document.documentElement.clientWidth * 70 / 100
                var pcHeight = document.documentElement.clientHeight * 95 / 100
                var scr = $(this).attr('src');
                var img = new Image();
                img.src = scr;
                var imgW = img.width;
                var imgH = img.height;
                if (imgH > imgW) {
                    img.height = pcHeight;
                    img.width = pcHeight * (imgW / imgH);
                } else if ((imgH <= imgW) && (imgH / imgW) > 0.7) {
                    img.height = pcHeight;
                    img.width = pcHeight * (imgW / imgH);
                } else {
                    img.width = pcWidth;
                    img.height = pcWidth * (imgH / imgW);
                }
                console.log('imgW', imgW)
                console.log('imgH', imgH)
                console.log('img.width', img.width)
                console.log('img.height', img.height)
                layer.open({
                    type: 1,
                    shade: [0.9, '#000'],
                    skin: 'imgLg', //加上边框
                    area: [img.width + 'px', img.height + 'px'], //宽高
                    shadeClose: true,
                    title: false, //不显示标题
                    content: '<img src="' + scr + '" />',
                });
            })

        })
</script>
</html>